<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Content System Test - Phase 4-D</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        
        .logs {
            max-height: 300px;
            overflow-y: auto;
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ Phase 4-D: Dynamic Content System Test</h1>
    
    <div class="test-container">
        <h2>ì‹œìŠ¤í…œ ìƒíƒœ</h2>
        <div id="system-status" class="status info">ì´ˆê¸°í™” ì¤‘...</div>
        
        <h3>ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testDynamicSystem()">ë™ì  ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</button>
        <button onclick="testStaticFallback()">ì •ì  í´ë°± í…ŒìŠ¤íŠ¸</button>
        <button onclick="testContentGeneration()">ì½˜í…ì¸  ìƒì„± í…ŒìŠ¤íŠ¸</button>
        <button onclick="testCaching()">ìºì‹± í…ŒìŠ¤íŠ¸</button>
        <button onclick="testServerConnection()">ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearCache()">ìºì‹œ í´ë¦¬ì–´</button>
        
        <h3>ì½˜í…ì¸  ì‹œìŠ¤í…œ ì •ë³´</h3>
        <div id="content-info" class="data-display">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="test-container">
        <h2>ì‹¤ì‹œê°„ ë¡œê·¸</h2>
        <div id="logs" class="logs"></div>
        <button onclick="clearLogs()">ë¡œê·¸ í´ë¦¬ì–´</button>
    </div>

    <script type="module">
        import DynamicContentSystem from './dynamic-content-system.js';
        import ContentGenerator from './content-generator.js';
        import { isFeatureEnabled, FEATURES } from './config.js';

        let dynamicSystem = null;
        let contentGenerator = null;
        
        // ë¡œê·¸ ì‹œìŠ¤í…œ
        const originalConsole = { ...console };
        const logContainer = document.getElementById('logs');
        
        function addLog(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logContainer.innerHTML += `[${timestamp}] [${level.toUpperCase()}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // ì›ë³¸ ì½˜ì†”ë„ í˜¸ì¶œ
            originalConsole[level](...args);
        }
        
        // ì½˜ì†” ì˜¤ë²„ë¼ì´ë“œ
        console.log = (...args) => addLog('log', ...args);
        console.warn = (...args) => addLog('warn', ...args);
        console.error = (...args) => addLog('error', ...args);
        
        // ì „ì—­ í•¨ìˆ˜ë“¤
        window.testDynamicSystem = async function() {
            try {
                updateStatus('ë™ì  ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
                
                if (!dynamicSystem) {
                    dynamicSystem = new DynamicContentSystem();
                    await dynamicSystem.initialize();
                }
                
                await dynamicSystem.checkForUpdates();
                updateStatus('ë™ì  ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!', 'success');
                updateContentInfo();
                
            } catch (error) {
                updateStatus(`ë™ì  ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };
        
        window.testStaticFallback = function() {
            updateStatus('ì •ì  í´ë°± í…ŒìŠ¤íŠ¸...', 'info');
            
            if (dynamicSystem) {
                dynamicSystem.enableOfflineMode();
                updateStatus('ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”ë¨', 'success');
            } else {
                import('./content-database.js').then(module => {
                    console.log('Static database loaded:', Object.keys(module.default).length, 'categories');
                    updateStatus('ì •ì  ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì™„ë£Œ', 'success');
                });
            }
            updateContentInfo();
        };
        
        window.testContentGeneration = function() {
            updateStatus('ì½˜í…ì¸  ìƒì„± í…ŒìŠ¤íŠ¸...', 'info');
            
            if (!contentGenerator) {
                contentGenerator = new ContentGenerator(dynamicSystem);
                
                // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
                import('./content-database.js').then(module => {
                    Object.keys(module.default).forEach(cat => {
                        Object.keys(module.default[cat]).forEach(src => {
                            contentGenerator.addContent(cat, src, module.default[cat][src]);
                        });
                    });
                    
                    // í…ŒìŠ¤íŠ¸ ë¬¸ì œ ìƒì„±
                    const testProblem = contentGenerator.generateRandomProblem('movies');
                    console.log('Generated test problem:', testProblem);
                    
                    updateStatus('ì½˜í…ì¸  ìƒì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ!', 'success');
                    updateContentInfo();
                });
            }
        };
        
        window.testCaching = function() {
            updateStatus('ìºì‹± í…ŒìŠ¤íŠ¸...', 'info');
            
            const testData = {
                version: 'test-1.0',
                content: {
                    test: {
                        'Test Source': [
                            { sentence: 'This is a test sentence.', translation: 'ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ë¬¸ì¥ì…ë‹ˆë‹¤.', difficulty: 'easy' }
                        ]
                    }
                }
            };
            
            localStorage.setItem('dynamic-content-cache', JSON.stringify(testData));
            updateStatus('í…ŒìŠ¤íŠ¸ ìºì‹œ ì €ì¥ ì™„ë£Œ!', 'success');
        };
        
        window.clearCache = function() {
            localStorage.removeItem('dynamic-content-cache');
            localStorage.removeItem('wordcrack_failed_uploads');
            updateStatus('ìºì‹œ í´ë¦¬ì–´ ì™„ë£Œ!', 'info');
            updateContentInfo();
        };
        
        window.testServerConnection = async function() {
            updateStatus('ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
            
            try {
                // API URL í™•ì¸
                const apiUrl = dynamicSystem ? dynamicSystem.getApiBaseUrl() : 
                    'https://wordcrack-api.letthelightsurroundyou.workers.dev';
                
                console.log('Testing API URL:', apiUrl);
                
                // ì„œë²„ ìƒíƒœ í™•ì¸
                const response = await fetch(`${apiUrl}/`);
                const data = await response.json();
                
                console.log('Server response:', data);
                
                // ì½˜í…ì¸  ë²„ì „ í™•ì¸
                const versionResponse = await fetch(`${apiUrl}/api/content/version`);
                const versionData = await versionResponse.json();
                
                console.log('Content version:', versionData);
                
                updateStatus(`ì„œë²„ ì—°ê²° ì„±ê³µ! ë²„ì „: ${versionData.version}`, 'success');
                
            } catch (error) {
                console.error('Server connection failed:', error);
                updateStatus(`ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };
        
        window.clearLogs = function() {
            logContainer.innerHTML = '';
        };
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('system-status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateContentInfo() {
            const infoEl = document.getElementById('content-info');
            
            const info = {
                dynamicSystemStatus: dynamicSystem ? 'Initialized' : 'Not initialized',
                contentGeneratorStatus: contentGenerator ? 'Initialized' : 'Not initialized',
                dynamicContentEnabled: isFeatureEnabled('DYNAMIC_CONTENT'),
                cacheSize: localStorage.getItem('dynamic-content-cache') ? 'Present' : 'Empty',
                systemInfo: contentGenerator ? contentGenerator.getSystemInfo() : null
            };
            
            infoEl.textContent = JSON.stringify(info, null, 2);
        }
        
        // ì´ˆê¸°í™”
        updateStatus('Phase 4-D ë™ì  ì½˜í…ì¸  ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨', 'success');
        updateContentInfo();
        
        // ê¸°ëŠ¥ í”Œë˜ê·¸ í‘œì‹œ
        console.log('Feature flags:', FEATURES);
        console.log('Dynamic content enabled:', isFeatureEnabled('DYNAMIC_CONTENT'));
        
    </script>
</body>
</html>